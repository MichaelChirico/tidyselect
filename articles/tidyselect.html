<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Implementing tidyselect interfaces • tidyselect</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Implementing tidyselect interfaces">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115082821-1');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">tidyselect</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.99.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/syntax.html">Technical description of tidyselect</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/tidyselect.html">Get started</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    News
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../news/index.html">Changelog</a>
    </li>
  </ul>
</li>
<li>
  <a href="https://github.com/r-lib/tidyselect">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Implementing tidyselect interfaces</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/tidyselect/blob/master/vignettes/tidyselect.Rmd"><code>vignettes/tidyselect.Rmd</code></a></small>
      <div class="hidden name"><code>tidyselect.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tidyselect)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(magrittr)</a></code></pre></div>
<p>tidyselect implements a specialised sublanguage of R for selecting variables from data frames and other data structures. A technical description of the DSL is available in the <a href="https://tidyselect.r-lib.org/articles/syntax.html">syntax vignette</a>.</p>
<p>In this vignette, we describe how to include tidyselect in your own packages. If you just want to know how to use tidyselect syntax in dplyr or tidyr, please read <a href="https://r4ds.had.co.nz/transform.html#select" class="uri">https://r4ds.had.co.nz/transform.html#select</a> instead.</p>
<div id="before-we-start" class="section level2">
<h2 class="hasAnchor">
<a href="#before-we-start" class="anchor"></a>Before we start</h2>
<div id="selections-as-dots-or-as-named-arguments" class="section level3">
<h3 class="hasAnchor">
<a href="#selections-as-dots-or-as-named-arguments" class="anchor"></a>Selections as dots or as named arguments</h3>
<p>There are two major ways of designing a function that takes selections.</p>
<ul>
<li>
<p>Passing <strong>dots</strong> as in <code><a href="https://dplyr.tidyverse.org/reference/select.html">dplyr::select()</a></code>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">mtcars <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(mpg, cyl)</a></code></pre></div>
</li>
<li>
<p>Interpolating <strong>named arguments</strong> as in <code>tidyr::pivot_longer()</code>. In this case, multiple inputs can be provided inside <code><a href="https://rdrr.io/r/base/c.html">c()</a></code> or by using boolean operators:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">mtcars <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_longer</span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(mpg, cyl))</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">mtcars <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pivot_longer</span>(mpg <span class="op">|</span><span class="st"> </span>cyl)</a></code></pre></div>
</li>
</ul>
<p>Our general recommendation is to take dots when the main purpose of the function is to create a new data structure based on a selection. When the selection is accessory to the main purpose of the function, take it as a named argument. In doubt, we recommend using named arguments because it is easier to change a named argument to dots than the other way around. For more advice about this, see the <a href="https://design.tidyverse.org/dots-data.html">Making data with <code>...</code></a> section of the tidyverse design book.</p>
</div>
<div id="do-you-need-tidyselect" class="section level3">
<h3 class="hasAnchor">
<a href="#do-you-need-tidyselect" class="anchor"></a>Do you need tidyselect?</h3>
<p>The tools described in this vignette are rather low level. Depending on your use case, it may be easier to wrap <code><a href="https://dplyr.tidyverse.org/reference/select.html">dplyr::select()</a></code>. You’ll get a data frame containing the columns selected by your user, which you can then handle in various ways.</p>
<p>The following examples illustrate how you could write a function that takes a selection of data and returns the corresponding data frame with capitalised names:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># Passing dots</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">toupper_dots &lt;-<span class="st"> </span><span class="cf">function</span>(data, ...) {</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">  sel &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(data, ...)</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">  rlang<span class="op">::</span><span class="kw"><a href="https://rlang.r-lib.org/reference/set_names.html">set_names</a></span>(sel, toupper)</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">}</a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="co"># Interpolating a named argument with {{ }}</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7">toupper_arg &lt;-<span class="st"> </span><span class="cf">function</span>(data, arg) {</a>
<a class="sourceLine" id="cb4-8" data-line-number="8">  sel &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(data, {{ arg }})</a>
<a class="sourceLine" id="cb4-9" data-line-number="9">  rlang<span class="op">::</span><span class="kw"><a href="https://rlang.r-lib.org/reference/set_names.html">set_names</a></span>(sel, toupper)</a>
<a class="sourceLine" id="cb4-10" data-line-number="10">}</a>
<a class="sourceLine" id="cb4-11" data-line-number="11"></a>
<a class="sourceLine" id="cb4-12" data-line-number="12">mtcars <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">toupper_dots</span>(mpg<span class="op">:</span>disp, vs)</a>
<a class="sourceLine" id="cb4-13" data-line-number="13"><span class="co">#&gt; # A tibble: 32 x 4</span></a>
<a class="sourceLine" id="cb4-14" data-line-number="14"><span class="co">#&gt;     MPG   CYL  DISP    VS</span></a>
<a class="sourceLine" id="cb4-15" data-line-number="15"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16"><span class="co">#&gt; 1  21       6   160     0</span></a>
<a class="sourceLine" id="cb4-17" data-line-number="17"><span class="co">#&gt; 2  21       6   160     0</span></a>
<a class="sourceLine" id="cb4-18" data-line-number="18"><span class="co">#&gt; 3  22.8     4   108     1</span></a>
<a class="sourceLine" id="cb4-19" data-line-number="19"><span class="co">#&gt; 4  21.4     6   258     1</span></a>
<a class="sourceLine" id="cb4-20" data-line-number="20"><span class="co">#&gt; # … with 28 more rows</span></a>
<a class="sourceLine" id="cb4-21" data-line-number="21"></a>
<a class="sourceLine" id="cb4-22" data-line-number="22">mtcars <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">toupper_arg</span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(mpg<span class="op">:</span>disp, vs))</a>
<a class="sourceLine" id="cb4-23" data-line-number="23"><span class="co">#&gt; # A tibble: 32 x 4</span></a>
<a class="sourceLine" id="cb4-24" data-line-number="24"><span class="co">#&gt;     MPG   CYL  DISP    VS</span></a>
<a class="sourceLine" id="cb4-25" data-line-number="25"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb4-26" data-line-number="26"><span class="co">#&gt; 1  21       6   160     0</span></a>
<a class="sourceLine" id="cb4-27" data-line-number="27"><span class="co">#&gt; 2  21       6   160     0</span></a>
<a class="sourceLine" id="cb4-28" data-line-number="28"><span class="co">#&gt; 3  22.8     4   108     1</span></a>
<a class="sourceLine" id="cb4-29" data-line-number="29"><span class="co">#&gt; 4  21.4     6   258     1</span></a>
<a class="sourceLine" id="cb4-30" data-line-number="30"><span class="co">#&gt; # … with 28 more rows</span></a></code></pre></div>
<p>The main advantage of the lower level tidyselect tools is that they offer a bit more information and flexibility. Instead of returning the selected data, they return the <strong>locations</strong> of selected elements inside the input data. If you don’t need the selected locations and can afford the dependency, you may consider wrapping dplyr instead.</p>
</div>
</div>
<div id="the-selection-evaluators" class="section level2">
<h2 class="hasAnchor">
<a href="#the-selection-evaluators" class="anchor"></a>The selection evaluators</h2>
<p>tidyselect is implemented with non-standard evaluation (NSE). This unique feature of the R language refers to the ability of functions to <strong>defuse</strong> (i.e. delay the execution) some or all of their arguments, and resume evaluation later on<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>. Crucially, evaluation can be resumed in a different context or according to different rules, which is often how domain-specific languages are created in R.</p>
<div id="defusing-and-resuming-evaluation-of-r-code" class="section level3">
<h3 class="hasAnchor">
<a href="#defusing-and-resuming-evaluation-of-r-code" class="anchor"></a>Defusing and resuming evaluation of R code</h3>
<p>When a function argument is defused, R halts the evaluation of the code and returns a defused expression instead. This expression contains the code that describes how to compute the intended value.</p>
<p>Defuse <em>your own</em> R code with <code>expr()</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">own &lt;-<span class="st"> </span>rlang<span class="op">::</span><span class="kw"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">expr</a></span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">own</a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="co">#&gt; 1 + 2</span></a></code></pre></div>
<p>Defuse <em>the user’s</em> R code with <code><a href="https://rlang.r-lib.org/reference/nse-defuse.html">enquo()</a></code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">fn &lt;-<span class="st"> </span><span class="cf">function</span>(arg) {</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">  expr &lt;-<span class="st"> </span>rlang<span class="op">::</span><span class="kw"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">enquo</a></span>(arg)</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">  expr</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">user &lt;-<span class="st"> </span><span class="kw">fn</span>(<span class="dv">1</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb6-6" data-line-number="6">user</a>
<a class="sourceLine" id="cb6-7" data-line-number="7"><span class="co">#&gt; &lt;quosure&gt;</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8"><span class="co">#&gt; expr: ^1 + 2</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9"><span class="co">#&gt; env:  global</span></a></code></pre></div>
<p>To resume the evaluation of the defused R code, use <code>eval_tidy()</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">rlang<span class="op">::</span><span class="kw"><a href="https://rlang.r-lib.org/reference/eval_tidy.html">eval_tidy</a></span>(own)</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="co">#&gt; [1] 3</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"></a>
<a class="sourceLine" id="cb7-4" data-line-number="4">rlang<span class="op">::</span><span class="kw"><a href="https://rlang.r-lib.org/reference/eval_tidy.html">eval_tidy</a></span>(user)</a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="co">#&gt; [1] 3</span></a></code></pre></div>
<p>You can resume the evaluation in data context by passing a data frame as <code>data</code> argument:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">with_data &lt;-<span class="st"> </span><span class="cf">function</span>(data, x) {</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">  expr &lt;-<span class="st"> </span>rlang<span class="op">::</span><span class="kw"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">enquo</a></span>(x)</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">  rlang<span class="op">::</span><span class="kw"><a href="https://rlang.r-lib.org/reference/eval_tidy.html">eval_tidy</a></span>(expr, <span class="dt">data =</span> data)</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">}</a></code></pre></div>
<p>Resuming evaluation in a data context is known as <strong>data masking</strong>. The data-vars inside the data frame are combined with the env-vars of the environment, making it possible for users to refer to their data variables:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="ot">NULL</span> <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">with_data</span>(<span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(cyl) <span class="op">*</span><span class="st"> </span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="co">#&gt; Error in mean(cyl): object 'cyl' not found</span></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"></a>
<a class="sourceLine" id="cb9-4" data-line-number="4">mtcars <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">with_data</span>(<span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(cyl) <span class="op">*</span><span class="st"> </span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="co">#&gt; [1] 61.875</span></a></code></pre></div>
</div>
<div id="resuming-defused-r-code-with-tidyselect-rules" class="section level3">
<h3 class="hasAnchor">
<a href="#resuming-defused-r-code-with-tidyselect-rules" class="anchor"></a>Resuming defused R code with tidyselect rules</h3>
<p>Taking tidyselect selections in your functions follows the same principles. First defuse an expression, then resume its evaluation. Instead of <code>eval_tidy()</code>, we need the special interpreters <code><a href="../reference/eval_select.html">eval_select()</a></code> and <code><a href="../reference/eval_select.html">eval_rename()</a></code>. Like <code>eval_tidy()</code>, they take a defused expression and some data. They return a vector of locations for the selected elements:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw"><a href="../reference/eval_select.html">eval_select</a></span>(rlang<span class="op">::</span><span class="kw"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">expr</a></span>(mpg), mtcars)</a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="co">#&gt; mpg </span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="co">#&gt;   1</span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4"></a>
<a class="sourceLine" id="cb10-5" data-line-number="5"><span class="kw"><a href="../reference/eval_select.html">eval_select</a></span>(rlang<span class="op">::</span><span class="kw"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">expr</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(mpg<span class="op">:</span>disp, vs)), mtcars)</a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="co">#&gt;  mpg  cyl disp   vs </span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7"><span class="co">#&gt;    1    2    3    8</span></a></code></pre></div>
<p>If the user has renamed some of the selected elements, the names of the vector of locations reflect the new names.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw"><a href="../reference/eval_select.html">eval_select</a></span>(rlang<span class="op">::</span><span class="kw"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">expr</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dt">foo =</span> mpg, <span class="dt">bar =</span> disp)), mtcars)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="co">#&gt; foo bar </span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="co">#&gt;   1   3</span></a>
<a class="sourceLine" id="cb11-4" data-line-number="4"></a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="kw"><a href="../reference/eval_select.html">eval_rename</a></span>(rlang<span class="op">::</span><span class="kw"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">expr</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dt">foo =</span> mpg, <span class="dt">bar =</span> disp)), mtcars)</a>
<a class="sourceLine" id="cb11-6" data-line-number="6"><span class="co">#&gt; foo bar </span></a>
<a class="sourceLine" id="cb11-7" data-line-number="7"><span class="co">#&gt;   1   3</span></a></code></pre></div>
<p><code><a href="../reference/eval_select.html">eval_select()</a></code> is most likely the variant that you’ll need to implement your tidyselect functions.</p>
<div id="simple-selections-with-dots" class="section level4">
<h4 class="hasAnchor">
<a href="#simple-selections-with-dots" class="anchor"></a>Simple selections with dots</h4>
<p>If your selecting function takes dots:</p>
<ol style="list-style-type: decimal">
<li><p>Pass the dots to <code><a href="https://rdrr.io/r/base/c.html">c()</a></code> inside a defused expression.</p></li>
<li><p>Resume evaluation of the defused <code><a href="https://rdrr.io/r/base/c.html">c()</a></code> expression with <code><a href="../reference/eval_select.html">eval_select()</a></code>.</p></li>
<li><p>Use the vector of locations returned by <code><a href="../reference/eval_select.html">eval_select()</a></code> to subset and rename the input data.</p></li>
</ol>
<p>Here is how to reimplement <code><a href="https://dplyr.tidyverse.org/reference/select.html">dplyr::select()</a></code> in 3 lines representing each of the steps above:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">select &lt;-<span class="st"> </span><span class="cf">function</span>(.data, ...) {</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">  expr &lt;-<span class="st"> </span>rlang<span class="op">::</span><span class="kw"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">expr</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(...))</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">  pos &lt;-<span class="st"> </span><span class="kw"><a href="../reference/eval_select.html">eval_select</a></span>(expr, <span class="dt">data =</span> .data)</a>
<a class="sourceLine" id="cb12-4" data-line-number="4">  rlang<span class="op">::</span><span class="kw"><a href="https://rlang.r-lib.org/reference/set_names.html">set_names</a></span>(.data[pos], <span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(pos))</a>
<a class="sourceLine" id="cb12-5" data-line-number="5">}</a>
<a class="sourceLine" id="cb12-6" data-line-number="6"></a>
<a class="sourceLine" id="cb12-7" data-line-number="7">mtcars <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-8" data-line-number="8"><span class="st">  </span><span class="kw">select</span>(mpg, cyl)</a>
<a class="sourceLine" id="cb12-9" data-line-number="9"><span class="co">#&gt; # A tibble: 32 x 2</span></a>
<a class="sourceLine" id="cb12-10" data-line-number="10"><span class="co">#&gt;     mpg   cyl</span></a>
<a class="sourceLine" id="cb12-11" data-line-number="11"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb12-12" data-line-number="12"><span class="co">#&gt; 1  21       6</span></a>
<a class="sourceLine" id="cb12-13" data-line-number="13"><span class="co">#&gt; 2  21       6</span></a>
<a class="sourceLine" id="cb12-14" data-line-number="14"><span class="co">#&gt; 3  22.8     4</span></a>
<a class="sourceLine" id="cb12-15" data-line-number="15"><span class="co">#&gt; 4  21.4     6</span></a>
<a class="sourceLine" id="cb12-16" data-line-number="16"><span class="co">#&gt; # … with 28 more rows</span></a></code></pre></div>
</div>
<div id="simple-selections-with-named-arguments" class="section level4">
<h4 class="hasAnchor">
<a href="#simple-selections-with-named-arguments" class="anchor"></a>Simple selections with named arguments</h4>
<p>If your selecting function takes named arguments, the defusing step is a bit different. We need to use <code><a href="https://rlang.r-lib.org/reference/nse-defuse.html">enquo()</a></code> to defuse the function argument itself.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">select &lt;-<span class="st"> </span><span class="cf">function</span>(.data, cols) {</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">  expr &lt;-<span class="st"> </span>rlang<span class="op">::</span><span class="kw"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">enquo</a></span>(cols)</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">  pos &lt;-<span class="st"> </span><span class="kw"><a href="../reference/eval_select.html">eval_select</a></span>(expr, <span class="dt">data =</span> .data)</a>
<a class="sourceLine" id="cb13-4" data-line-number="4">  rlang<span class="op">::</span><span class="kw"><a href="https://rlang.r-lib.org/reference/set_names.html">set_names</a></span>(.data[pos], <span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(pos))</a>
<a class="sourceLine" id="cb13-5" data-line-number="5">}</a>
<a class="sourceLine" id="cb13-6" data-line-number="6"></a>
<a class="sourceLine" id="cb13-7" data-line-number="7">mtcars <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-8" data-line-number="8"><span class="st">  </span><span class="kw">select</span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(mpg, cyl))</a>
<a class="sourceLine" id="cb13-9" data-line-number="9"><span class="co">#&gt; # A tibble: 32 x 2</span></a>
<a class="sourceLine" id="cb13-10" data-line-number="10"><span class="co">#&gt;     mpg   cyl</span></a>
<a class="sourceLine" id="cb13-11" data-line-number="11"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb13-12" data-line-number="12"><span class="co">#&gt; 1  21       6</span></a>
<a class="sourceLine" id="cb13-13" data-line-number="13"><span class="co">#&gt; 2  21       6</span></a>
<a class="sourceLine" id="cb13-14" data-line-number="14"><span class="co">#&gt; 3  22.8     4</span></a>
<a class="sourceLine" id="cb13-15" data-line-number="15"><span class="co">#&gt; 4  21.4     6</span></a>
<a class="sourceLine" id="cb13-16" data-line-number="16"><span class="co">#&gt; # … with 28 more rows</span></a></code></pre></div>
</div>
<div id="renaming-selections" class="section level4">
<h4 class="hasAnchor">
<a href="#renaming-selections" class="anchor"></a>Renaming selections</h4>
<p>The <code><a href="../reference/eval_select.html">eval_rename()</a></code> variant is rarely needed and only mentioned here for completeness. First note that both <code><a href="../reference/eval_select.html">eval_select()</a></code> and <code><a href="../reference/eval_select.html">eval_rename()</a></code> allow renaming variables:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw"><a href="../reference/eval_select.html">eval_select</a></span>(rlang<span class="op">::</span><span class="kw"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">expr</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dt">foo =</span> mpg)), mtcars)</a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="co">#&gt; foo </span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="co">#&gt;   1</span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4"></a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="kw"><a href="../reference/eval_select.html">eval_rename</a></span>(rlang<span class="op">::</span><span class="kw"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">expr</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dt">foo =</span> mpg)), mtcars)</a>
<a class="sourceLine" id="cb14-6" data-line-number="6"><span class="co">#&gt; foo </span></a>
<a class="sourceLine" id="cb14-7" data-line-number="7"><span class="co">#&gt;   1</span></a></code></pre></div>
<p><code><a href="../reference/eval_select.html">eval_rename()</a></code> is very similar to <code><a href="../reference/eval_select.html">eval_select()</a></code> but it has more constraints because it is meant for renaming variables in place. In particular it throws an error if the selected inputs are unnamed. In practice, <code><a href="../reference/eval_select.html">eval_rename()</a></code> only accepts a <code><a href="https://rdrr.io/r/base/c.html">c()</a></code> expression as <code>expr</code> argument, and all inputs inside the outermost <code><a href="https://rdrr.io/r/base/c.html">c()</a></code> must be named:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="kw"><a href="../reference/eval_select.html">eval_rename</a></span>(rlang<span class="op">::</span><span class="kw"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">expr</a></span>(mpg), mtcars)</a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="co">#&gt; Error: All renaming inputs must be named.</span></a>
<a class="sourceLine" id="cb15-3" data-line-number="3"></a>
<a class="sourceLine" id="cb15-4" data-line-number="4"><span class="kw"><a href="../reference/eval_select.html">eval_rename</a></span>(rlang<span class="op">::</span><span class="kw"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">expr</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(mpg)), mtcars)</a>
<a class="sourceLine" id="cb15-5" data-line-number="5"><span class="co">#&gt; Error: All renaming inputs must be named.</span></a>
<a class="sourceLine" id="cb15-6" data-line-number="6"></a>
<a class="sourceLine" id="cb15-7" data-line-number="7"><span class="kw"><a href="../reference/eval_select.html">eval_rename</a></span>(rlang<span class="op">::</span><span class="kw"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">expr</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dt">foo =</span> mpg)), mtcars)</a>
<a class="sourceLine" id="cb15-8" data-line-number="8"><span class="co">#&gt; foo </span></a>
<a class="sourceLine" id="cb15-9" data-line-number="9"><span class="co">#&gt;   1</span></a></code></pre></div>
<p>Because of this constraint, it doesn’t make much sense to take a named argument, most of the time you’ll want to pass dots to a defused <code><a href="https://rdrr.io/r/base/c.html">c()</a></code> expression. This way the user can easily pass names with the selections:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">wrapper &lt;-<span class="st"> </span><span class="cf">function</span>(data, ...) {</a>
<a class="sourceLine" id="cb16-2" data-line-number="2">  <span class="kw"><a href="../reference/eval_select.html">eval_rename</a></span>(rlang<span class="op">::</span><span class="kw"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">expr</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(...)), data)</a>
<a class="sourceLine" id="cb16-3" data-line-number="3">}</a>
<a class="sourceLine" id="cb16-4" data-line-number="4"></a>
<a class="sourceLine" id="cb16-5" data-line-number="5">mtcars <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">wrapper</span>(<span class="dt">foo =</span> mpg, <span class="dt">bar =</span> hp<span class="op">:</span>wt)</a>
<a class="sourceLine" id="cb16-6" data-line-number="6"><span class="co">#&gt;  foo bar1 bar2 bar3 </span></a>
<a class="sourceLine" id="cb16-7" data-line-number="7"><span class="co">#&gt;    1    4    5    6</span></a></code></pre></div>
<p>As an example of how to use the vector of locations returned by <code><a href="../reference/eval_select.html">eval_rename()</a></code>, here is how to implement <code><a href="https://dplyr.tidyverse.org/reference/select.html">dplyr::rename()</a></code>:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">rename &lt;-<span class="st"> </span><span class="cf">function</span>(.data, ...) {</a>
<a class="sourceLine" id="cb17-2" data-line-number="2">  pos &lt;-<span class="st"> </span><span class="kw"><a href="../reference/eval_select.html">eval_rename</a></span>(rlang<span class="op">::</span><span class="kw"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">expr</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(...)), .data)</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">  <span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(.data)[pos] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(pos)</a>
<a class="sourceLine" id="cb17-4" data-line-number="4">  .data</a>
<a class="sourceLine" id="cb17-5" data-line-number="5">}</a>
<a class="sourceLine" id="cb17-6" data-line-number="6"></a>
<a class="sourceLine" id="cb17-7" data-line-number="7">mtcars <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-8" data-line-number="8"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">foo =</span> mpg, <span class="dt">bar =</span> hp<span class="op">:</span>wt)</a>
<a class="sourceLine" id="cb17-9" data-line-number="9"><span class="co">#&gt; # A tibble: 32 x 11</span></a>
<a class="sourceLine" id="cb17-10" data-line-number="10"><span class="co">#&gt;     foo   cyl  disp  bar1  bar2  bar3  qsec    vs    am  gear  carb</span></a>
<a class="sourceLine" id="cb17-11" data-line-number="11"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb17-12" data-line-number="12"><span class="co">#&gt; 1  21       6   160   110  3.9   2.62  16.5     0     1     4     4</span></a>
<a class="sourceLine" id="cb17-13" data-line-number="13"><span class="co">#&gt; 2  21       6   160   110  3.9   2.88  17.0     0     1     4     4</span></a>
<a class="sourceLine" id="cb17-14" data-line-number="14"><span class="co">#&gt; 3  22.8     4   108    93  3.85  2.32  18.6     1     1     4     1</span></a>
<a class="sourceLine" id="cb17-15" data-line-number="15"><span class="co">#&gt; 4  21.4     6   258   110  3.08  3.22  19.4     1     0     3     1</span></a>
<a class="sourceLine" id="cb17-16" data-line-number="16"><span class="co">#&gt; # … with 28 more rows</span></a></code></pre></div>
</div>
</div>
</div>
<div id="creating-selection-helpers" class="section level2">
<h2 class="hasAnchor">
<a href="#creating-selection-helpers" class="anchor"></a>Creating selection helpers</h2>
<p>Tools like <code><a href="../reference/select_helpers.html">starts_with()</a></code> or <code><a href="../reference/select_helpers.html">contains()</a></code> are called <strong>selection helpers</strong>. These tools inspect the variable names currently available for selection with <code><a href="../reference/peek_vars.html">peek_vars()</a></code>. The variable names are registered automatically by <code><a href="../reference/eval_select.html">eval_select()</a></code> for the duration of the evaluation:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">x &lt;-<span class="st"> </span>rlang<span class="op">::</span><span class="kw"><a href="https://rlang.r-lib.org/reference/nse-defuse.html">expr</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw"><a href="../reference/peek_vars.html">peek_vars</a></span>()))</a>
<a class="sourceLine" id="cb18-2" data-line-number="2"></a>
<a class="sourceLine" id="cb18-3" data-line-number="3"><span class="kw"><a href="https://rdrr.io/r/base/invisible.html">invisible</a></span>(<span class="kw"><a href="../reference/eval_select.html">eval_select</a></span>(x, <span class="dt">data =</span> mtcars))</a>
<a class="sourceLine" id="cb18-4" data-line-number="4"><span class="co">#&gt;  [1] "mpg"  "cyl"  "disp" "hp"   "drat" "wt"   "qsec" "vs"   "am"   "gear"</span></a>
<a class="sourceLine" id="cb18-5" data-line-number="5"><span class="co">#&gt; [11] "carb"</span></a></code></pre></div>
<p>Such properties temporarily available by calling a function like <code><a href="../reference/peek_vars.html">peek_vars()</a></code> are called <strong>descriptors</strong>. Descriptors are useful because they are very easy to compose. For instance, a user could combine <code><a href="../reference/select_helpers.html">starts_with()</a></code> and <code><a href="../reference/select_helpers.html">ends_with()</a></code> without having to worry about passing the variables or the environment in which they can be found:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1">my_selector &lt;-<span class="st"> </span><span class="cf">function</span>(prefix, suffix) {</a>
<a class="sourceLine" id="cb19-2" data-line-number="2">  <span class="kw"><a href="https://rdrr.io/r/base/sets.html">intersect</a></span>(</a>
<a class="sourceLine" id="cb19-3" data-line-number="3">    <span class="kw"><a href="../reference/select_helpers.html">starts_with</a></span>(prefix),</a>
<a class="sourceLine" id="cb19-4" data-line-number="4">    <span class="kw"><a href="../reference/select_helpers.html">ends_with</a></span>(suffix)</a>
<a class="sourceLine" id="cb19-5" data-line-number="5">  )</a>
<a class="sourceLine" id="cb19-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb19-7" data-line-number="7"></a>
<a class="sourceLine" id="cb19-8" data-line-number="8">iris <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">my_selector</span>(<span class="st">"Sepal"</span>, <span class="st">"Length"</span>))</a>
<a class="sourceLine" id="cb19-9" data-line-number="9"><span class="co">#&gt; # A tibble: 150 x 1</span></a>
<a class="sourceLine" id="cb19-10" data-line-number="10"><span class="co">#&gt;   Sepal.Length</span></a>
<a class="sourceLine" id="cb19-11" data-line-number="11"><span class="co">#&gt;          &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb19-12" data-line-number="12"><span class="co">#&gt; 1          5.1</span></a>
<a class="sourceLine" id="cb19-13" data-line-number="13"><span class="co">#&gt; 2          4.9</span></a>
<a class="sourceLine" id="cb19-14" data-line-number="14"><span class="co">#&gt; 3          4.7</span></a>
<a class="sourceLine" id="cb19-15" data-line-number="15"><span class="co">#&gt; 4          4.6</span></a>
<a class="sourceLine" id="cb19-16" data-line-number="16"><span class="co">#&gt; # … with 146 more rows</span></a></code></pre></div>
<p>To create a new selection helper:</p>
<ol style="list-style-type: decimal">
<li><p>Inspect the variables with <code><a href="../reference/peek_vars.html">peek_vars()</a></code>. By convention this should be done in an argument that the user can override.</p></li>
<li><p>Return one of the supported data types: vector of names or locations (the latter is recommended, see section on handling duplicate variables), or a predicate function.</p></li>
</ol>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">if_width &lt;-<span class="st"> </span><span class="cf">function</span>(n, <span class="dt">vars =</span> <span class="kw"><a href="../reference/peek_vars.html">peek_vars</a></span>(<span class="dt">fn =</span> <span class="st">"if_width"</span>)) {</a>
<a class="sourceLine" id="cb20-2" data-line-number="2">  vars[<span class="kw"><a href="https://rdrr.io/r/base/nchar.html">nchar</a></span>(vars) <span class="op">==</span><span class="st"> </span>n]</a>
<a class="sourceLine" id="cb20-3" data-line-number="3">}</a>
<a class="sourceLine" id="cb20-4" data-line-number="4"></a>
<a class="sourceLine" id="cb20-5" data-line-number="5">mtcars <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">if_width</span>(<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb20-6" data-line-number="6"><span class="co">#&gt; # A tibble: 32 x 4</span></a>
<a class="sourceLine" id="cb20-7" data-line-number="7"><span class="co">#&gt;      hp    wt    vs    am</span></a>
<a class="sourceLine" id="cb20-8" data-line-number="8"><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></a>
<a class="sourceLine" id="cb20-9" data-line-number="9"><span class="co">#&gt; 1   110  2.62     0     1</span></a>
<a class="sourceLine" id="cb20-10" data-line-number="10"><span class="co">#&gt; 2   110  2.88     0     1</span></a>
<a class="sourceLine" id="cb20-11" data-line-number="11"><span class="co">#&gt; 3    93  2.32     1     1</span></a>
<a class="sourceLine" id="cb20-12" data-line-number="12"><span class="co">#&gt; 4   110  3.22     1     0</span></a>
<a class="sourceLine" id="cb20-13" data-line-number="13"><span class="co">#&gt; # … with 28 more rows</span></a></code></pre></div>
<p>The <code>fn</code> argument makes the error message more informative when the helper is used in the wrong context:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">mtcars[<span class="kw">if_width</span>(<span class="dv">2</span>)]</a>
<a class="sourceLine" id="cb21-2" data-line-number="2"><span class="co">#&gt; Error: `if_width()` must be used within a *selecting* function.</span></a>
<a class="sourceLine" id="cb21-3" data-line-number="3"><span class="co">#&gt; ℹ See &lt;https://tidyselect.r-lib.org/reference/faq-selection-context.html&gt;.</span></a></code></pre></div>
<p>Because the variables are inspected in a default argument, it is easy to override. This is mostly useful in unit tests:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="kw">if_width</span>(<span class="dv">2</span>, <span class="dt">vars =</span> <span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(mtcars))</a>
<a class="sourceLine" id="cb22-2" data-line-number="2"><span class="co">#&gt; [1] "hp" "wt" "vs" "am"</span></a></code></pre></div>
<div id="handling-duplicate-variables" class="section level3">
<h3 class="hasAnchor">
<a href="#handling-duplicate-variables" class="anchor"></a>Handling duplicate variables</h3>
<p>However our current implementation of <code>if_width()</code> has a design flaw. It doesn’t work properly when the input has duplicate names:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1">dups &lt;-<span class="st"> </span>vctrs<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/vctrs/man/new_data_frame.html">new_data_frame</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">foo =</span> <span class="dv">1</span>, <span class="dt">quux =</span> <span class="dv">2</span>, <span class="dt">foo =</span> <span class="dv">3</span>))</a>
<a class="sourceLine" id="cb23-2" data-line-number="2"></a>
<a class="sourceLine" id="cb23-3" data-line-number="3">dups <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">if_width</span>(<span class="dv">3</span>))</a>
<a class="sourceLine" id="cb23-4" data-line-number="4"><span class="co">#&gt;   foo</span></a>
<a class="sourceLine" id="cb23-5" data-line-number="5"><span class="co">#&gt; 1   1</span></a></code></pre></div>
<p>Supporting duplicates is recommended because data frames in the wild don’t always have unique names. Also, tidyselect can be used with vectors that don’t require unique names, and it might be extended to allow recoding character vectors in the future. In these cases, handling duplicates is part of the normal usage for selection helpers.</p>
<p>To support duplicates it is recommended to return vectors of locations from selection helpers rather than vector of names. Fixing <code>if_width()</code> is easy:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1">if_width &lt;-<span class="st"> </span><span class="cf">function</span>(n, <span class="dt">vars =</span> <span class="kw"><a href="../reference/peek_vars.html">peek_vars</a></span>(<span class="dt">fn =</span> <span class="st">"if_width"</span>)) {</a>
<a class="sourceLine" id="cb24-2" data-line-number="2">  <span class="kw"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/nchar.html">nchar</a></span>(vars) <span class="op">==</span><span class="st"> </span>n)</a>
<a class="sourceLine" id="cb24-3" data-line-number="3">}</a></code></pre></div>
<p>If the input is a data frame, the user is now informed that their selection should not contain duplicates:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1">dups <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">if_width</span>(<span class="dv">3</span>))</a>
<a class="sourceLine" id="cb25-2" data-line-number="2"><span class="co">#&gt; Error: Names must be unique.</span></a></code></pre></div>
<p>And all the duplicates are selected if the input is not a data frame, as expected:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/list.html">as.list</a></span>(dups) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">if_width</span>(<span class="dv">3</span>))</a>
<a class="sourceLine" id="cb26-2" data-line-number="2"><span class="co">#&gt; $foo</span></a>
<a class="sourceLine" id="cb26-3" data-line-number="3"><span class="co">#&gt; [1] 1</span></a>
<a class="sourceLine" id="cb26-4" data-line-number="4"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb26-5" data-line-number="5"><span class="co">#&gt; $foo</span></a>
<a class="sourceLine" id="cb26-6" data-line-number="6"><span class="co">#&gt; [1] 3</span></a></code></pre></div>
</div>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>The defusing step is also known as <em>quoting</em>.<a href="#fnref1" class="footnote-back">↩</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#before-we-start">Before we start</a></li>
      <li><a href="#the-selection-evaluators">The selection evaluators</a></li>
      <li><a href="#creating-selection-helpers">Creating selection helpers</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Lionel Henry, <a href="http://hadley.nz">Hadley Wickham</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
